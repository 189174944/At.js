
(function($){Mirror=function($origin){this.init($origin);}Mirror.prototype={$mirror:null,css:["overflowY","height","width","paddingTop","paddingLeft","paddingRight","paddingBottom","marginTop","marginLeft","marginRight","marginBottom",'fontFamily','borderStyle','borderWidth','wordWrap','fontSize','lineHeight','overflowX'],init:function($origin){$mirror=$('<div></div>');var css={opacity:0,position:'absolute',left:0,top:0,zIndex:-20000,'word-wrap':'break-word','white-space':'pre-wrap'}$.each(this.css,function(i,p){css[p]=$origin.css(p);});$mirror.css(css);$('body').append($mirror);this.$mirror=$mirror;},setContent:function(html){this.$mirror.html(html);},getFlagPos:function(){return this.$mirror.find("span#flag").position();}};At={keyword:{'text':"",'start':0,'stop':0},search_word:"",_cache:{},$inputor:null,inputor_keys:[],lenght:0,pos:0,offset:function(){$inputor=this.$inputor;mirror=$inputor.data("mirror");if(mirror==undefined){mirror=new Mirror($inputor);$inputor.data("mirror",mirror);}function format(value){value=value.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/`/g,'&#96;').replace(/"/g,'&quot;');if($.browser.msie)value=value.replace(/ /g,"<span> </span>");return value.replace(/\r\n|\r|\n/g,"<br />");}text=$inputor.val();start_range=text.slice(0,this.pos);end_range=text.slice(this.pos+1);html="<span>"+format(start_range)+"</span>";html+="<span id='flag'>@</span>";html+="<span>"+format(end_range)+"</span>";mirror.setContent(html);offset=$inputor.offset();at_pos=mirror.getFlagPos();line_height=$inputor.css("line-height");line_height=isNaN(line_height)?20:line_height;y=offset.top+at_pos.top+line_height
-$inputor.scrollTop();x=offset.left+at_pos.left-$inputor.scrollLeft();return{'top':y,'left':x};},cache:function(key,value){if(!settings['cache'])return null;log("cacheing",key,value);if(value)this._cache[key]=value;return this._cache[key];},getKey:function(){$inputor=this.$inputor;text=$inputor.val();caret_pos=$inputor.caretPos();subtext=text.slice(0,caret_pos);word=subtext.match(/@\w+$|@[^\x00-\xff]+$/g);key=null;if(!word){this.view.hide();return null;}word=word.join("").slice(1);start=caret_pos-word.length;end=start+word.length;this.pos=start-1;key={'text':word,'start':start,'end':end};this.keyword=key;log("getKey",key);return key;},onkeydown:function(e){view=this.view;if(!view.running())return true;last_idx=view.items.length-1;switch(e.keyCode){case 38:$(view.id+" ul li.cur").removeClass("cur");view.cur_li_idx--;if(view.cur_li_idx<0)view.cur_li_idx=last_idx;$(view.id+" li:eq("+view.cur_li_idx+")").addClass('cur');return false;break;case 40:$(view.id+" ul li.cur").removeClass("cur");view.cur_li_idx++;if(view.cur_li_idx>last_idx)view.cur_li_idx=0;$(view.id+" li:eq("+view.cur_li_idx+")").addClass('cur');return false;break;case 13:$(view.id+" ul li.cur").removeClass("cur");$cur_li=$(view.id+" li:eq("+view.cur_li_idx+")");this.choose($cur_li);view.hide();return false;break;default:return true}},replaceStr:function(str){key=this.keyword;source=this.$inputor.val();start_str=source.slice(0,key.start);text=start_str+str+source.slice(key.end);this.$inputor.val(text);this.$inputor.caretPos(start_str.length+str.length);},choose:function($li){this.replaceStr($li.attr("data-insert")+" ");this.view.hide();},reg:function(inputor){$inputor=$(inputor);key=$inputor.data("@reg-key");log("reg",inputor,key);if($.inArray(key,this.inputor_keys)>=0)return null;key="@-"+$.now();this.inputor_keys[key];var self=this;$inputor.bind("keydown",function(e){return self.onkeydown(e);}).scroll(function(e){self.view.hide();}).blur(function(e){self.view.timeout_id=setTimeout("At.view.hide()",100);});return key;},run:function(inputor){this.$inputor=$(inputor);key=this.getKey();if(!key)return false;if(!isNil(names=this.cache(this.keyword.text))){log("cache data",names);this.view.load(names,false);}else if(!isNil(names=this.runWithData(key,settings['data']))){log("statis data",names);this.view.load(names,false);}else{callback=settings['callback'];log("callbacking",callback);this.view.hide();if($.isFunction(callback)){callback(At);}}},runWithData:function(key,data){var items=null;var self=this;if($.isArray(data)&&data.length!=0){items=$.map(data,function(item,i){var name=$.isPlainObject(item)?item[self.search_word]:item;match=name.match((new RegExp(key.text,"i")));return match?item:null;});}return items;}};At.view={cur_li_idx:0,timeout_id:null,id:'#at-view',jqo:null,items:[],running:function(){return $(this.id).is(":visible");},evalTpl:function(tpl,map){if(isNil(tpl))return;el=tpl.replace(/\$\{([^\}]*)\}/g,function(tag,key,pos){return map[key];});log("evalTpl",el);return el;},jqObject:function(o){if(!isNil(o))this.jqo=o;return isNil(this.jqo)?$(this.id):this.jqo;},onLoaded:function($view){$view.find('li').live('click',function(e){At.choose($(this));});$view.mousemove(function(e){if(e.target.tagName=="LI"){$(this).find("li.cur").removeClass("cur");$(e.target).addClass("cur");At.cur_li_idx=$(this).find("li").index(e.target)}});},rePosition:function($view){$view.offset(At.offset());},show:function(){if(!this.running())$view=$(this.id).show();this.rePosition($view);},hide:function(){if(!this.running())return;this.cur_li_idx=0;$(this.id).hide();},load:function(list,cacheable){if(isNil(this.jqObject())){tpl="<div id='"+this.id.slice(1)+"' class='at-view'><span id='title'>@who?</span><ul id='"+this.id.slice(1)+"-ul'></ul></div>";$at_view=$(tpl);$('body').append($at_view);this.jqObject($at_view=$(this.id));this.onLoaded($at_view);}return this.update(list,cacheable);},clear:function(clear_all){if(clear_all==true)this._cache={};this.items=[];this.jqObject().find('ul').empty();},update:function(list,cacheable){if(!$.isArray(list))return false;if(cacheable!=false)At.cache(At.keyword.text,list);$ul=this.jqObject().find('ul');this.clear();$.merge(this.items,list);var tpl=settings['tpl'];var self=this;$.each(list,function(i,item){if(!$.isPlainObject)item={'id':i,'name':item};$ul.append(self.evalTpl(tpl,item));});this.show();$ul.find("li:eq(0)").addClass("cur");}};function isNil(target){empty_array=$.isArray(target)&&target.length==0;nil_jquery=target instanceof $&&target.length==0;return!target||$.isEmptyObject(target)||empty_array||nil_jquery||target===undefined;}function log(){if(!settings['debug']||$.browser.msie)return;console.log(arguments);}function setSettings(options){opt={};if($.isFunction(options))opt['callback']=options;else
opt=options;return $.extend({'callback':function(context){return[]},'cache':true,'debug':false,'tpl':"<li id='${id}' data-insert='${name}'>${name}</li>",'data':[]},opt);}$.fn.atWho=function(options){settings=setSettings(options);log("settings",settings);var match=/data-insert=['?]\$\{(\w+)\}/g.exec(settings['tpl']);At.search_word=match[1];return this.each(function(){if(!At.reg(this))return;$(this).bind("keyup",function(e){run=At.view.running()&&(e.keyCode==40||e.keyCode==38);if(!run)At.run(this);}).mouseup(function(e){At.run(this);});});}})(jQuery);
